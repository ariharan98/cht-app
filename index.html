<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <link href="https://fonts.googleapis.com/css2?family=Anek+Tamil:wght@400;500;600;700&display=swap" rel="stylesheet">
    <title>அரட்டை</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            height: 100vh;
            color: white;
            overflow: hidden;
            background: #0a0a0a;
            transition: background 0.3s ease, color 0.3s ease;
        }

        :lang(ta) {
            font-family: 'Anek Tamil', sans-serif;
            font-weight: 500;
            line-height: 1.65;
        }

        #loginScreen {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background: linear-gradient(135deg, #1a1a1a 0%, #000 100%);
            padding: 20px;
        }

        .login-container {
            background: rgba(20, 20, 20, 0.95);
            padding: 50px;
            border-radius: 20px;
            border: 1px solid rgba(224, 0, 0, 0.3);
            box-shadow: 0 20px 60px rgba(224, 0, 0, 0.4);
            max-width: 450px;
            width: 100%;
            backdrop-filter: blur(10px);
            position: relative;
        }

        .login-icon {
            width: 80px;
            height: 80px;
            border-radius: 20px;
            border: 2px solid #e00000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            margin: 0 auto 20px;
            background: rgba(224, 0, 0, 0.1);
        }

        .login-header {
            text-align: center;
            margin-bottom: 35px;
        }

        .login-header h1 {
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(45deg, #e00000, #ff6347);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .login-header p {
            color: #aaa;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            color: #fff;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            display: block;
        }

        .form-group input {
            width: 100%;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(224, 0, 0, 0.3);
            border-radius: 12px;
            color: white;
            font-size: 15px;
            transition: all 0.3s ease;
        }

        .form-group input::placeholder {
            color: #666;
        }

        .form-group input:focus {
            outline: none;
            border-color: #e00000;
            background: rgba(255, 255, 255, 0.08);
        }

        .btn-primary {
            width: 100%;
            padding: 16px;
            background: linear-gradient(45deg, #e00000, #ff6347);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(224, 0, 0, 0.4);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .info-text {
            margin-top: 20px;
            color: #888;
            font-size: 12px;
            text-align: center;
        }

        #chatScreen {
            display: none;
            flex-direction: column;
            height: 100vh;
            background: #0a0a0a;
        }

        .chat-header {
            padding: 20px 30px;
            background: rgba(20, 20, 20, 0.95);
            border-bottom: 2px solid rgba(224, 0, 0, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            backdrop-filter: blur(10px);
        }

        .chat-header-left h2 {
            font-size: 20px;
            font-weight: 700;
            background: linear-gradient(45deg, #e00000, #ff6347);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 5px;
        }

        .chat-status {
            color: #aaa;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #e00000;
            border-radius: 50%;
            animation: pulseGlow 1.8s infinite;
        }

        .chat-header-right {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-secondary {
            padding: 10px 18px;
            background: rgba(224, 0, 0, 0.2);
            border: 2px solid rgba(224, 0, 0, 0.4);
            border-radius: 10px;
            color: white;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-secondary:hover {
            background: rgba(224, 0, 0, 0.3);
            border-color: #e00000;
            transform: translateY(-2px);
        }

        .messages-container {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            background: #0a0a0a;
            background-image:
                radial-gradient(circle at 20% 50%, rgba(224, 0, 0, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(224, 0, 0, 0.03) 0%, transparent 50%);
        }

        .messages-container::-webkit-scrollbar {
            width: 8px;
        }

        .messages-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        .messages-container::-webkit-scrollbar-thumb {
            background: rgba(224, 0, 0, 0.4);
            border-radius: 10px;
        }

        .messages-container::-webkit-scrollbar-thumb:hover {
            background: rgba(224, 0, 0, 0.6);
        }

        .message {
            display: flex;
            margin-bottom: 15px;
            animation: fadeSlideUp 0.35s ease-out;
        }

        .message.sent {
            justify-content: flex-end;
        }

        .message.received,
        .message.private,
        .message.system {
            justify-content: flex-start;
        }

        .message-bubble {
            max-width: 60%;
            font-size: 15px;
            padding: 12px 18px;
            border-radius: 18px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .message.sent .message-bubble {
            background: linear-gradient(45deg, #e00000, #ff6347);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.received .message-bubble {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-bottom-left-radius: 4px;
        }

        .message.private .message-bubble {
            background: rgba(251, 191, 36, 0.2);
            border: 2px solid #fbbf24;
            color: #fbbf24;
            border-bottom-left-radius: 4px;
        }

        .message.system .message-bubble {
            background: rgba(75, 85, 99, 0.3);
            color: #aaa;
            font-size: 13px;
            text-align: center;
            max-width: 80%;
            margin: 0 auto;
        }

        .message-sender {
            font-weight: 600;
            font-size: 12px;
            margin-bottom: 4px;
            opacity: 0.9;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 4px;
            text-align: right;
        }

        .input-container {
            padding: 20px 30px;
            background: rgba(20, 20, 20, 0.95);
            border-top: 2px solid rgba(224, 0, 0, 0.3);
            display: flex;
            gap: 12px;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .btn-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: rgba(224, 0, 0, 0.2);
            border: 2px solid rgba(224, 0, 0, 0.3);
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-icon:hover {
            background: rgba(224, 0, 0, 0.3);
            transform: scale(1.05);
        }


        #messageInput {
            flex: 1;
            width: 100%;
            min-height: 44px;
            max-height: 140px;
            padding: 12px 16px;
            font-size: 15px;
            line-height: 1.4;
            resize: none;
            overflow-y: hidden;
            overflow-x: hidden;
            border-radius: 20px;
            border: 2px solid rgba(224, 0, 0, 0.3);
            background: rgba(255, 255, 255, 0.05);
            color: white;
            transition: border-color 0.25s ease, background 0.25s ease;
            scrollbar-width: thin;
            scrollbar-color: rgba(224, 0, 0, 0.45) transparent;
        }

        #messageInput::placeholder {
            color: #666;
        }

        #messageInput:focus {
            outline: none;
            border-color: #e00000;
            background: rgba(255, 255, 255, 0.08);
        }


        #messageInput::placeholder {
            color: #666;
        }

        #messageInput:focus {
            outline: none;
            border-color: #e00000;
            background: rgba(255, 255, 255, 0.08);
        }

        #messageInput::-webkit-scrollbar-track {
            background: transparent;
        }

        #messageInput::-webkit-scrollbar-thumb {
            background: rgba(224, 0, 0, 0.35);
            border-radius: 10px;
        }

        #messageInput::-webkit-scrollbar-thumb:hover {
            background: rgba(224, 0, 0, 0.6);
        }

        .btn-send {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(45deg, #e00000, #ff6347);
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-send:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 20px rgba(224, 0, 0, 0.4);
        }

        .btn-send:active {
            transform: scale(1);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: rgba(20, 20, 20, 0.98);
            border-radius: 20px;
            border: 2px solid rgba(224, 0, 0, 0.3);
            max-width: 500px;
            width: 90%;
            max-height: 85vh;
            overflow: hidden;
            animation: modalSlideIn 0.3s ease-out;
        }

        .preview-wrapper {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 14px;
            padding: 10px;
            margin-bottom: 15px;
        }

        .preview-content {
            max-width: 100%;
            max-height: 70vh;
            overflow: auto;
            border-radius: 12px;
        }

        .preview-content img,
        .preview-content video,
        .preview-content iframe {
            width: 100%;
            height: auto;
            border-radius: 12px;
        }

        .preview-content audio {
            width: 100%;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            padding: 20px 25px;
            border-bottom: 2px solid rgba(224, 0, 0, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            color: white;
            font-size: 20px;
            font-weight: 600;
        }

        .btn-close {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: rgba(224, 0, 0, 0.2);
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-close:hover {
            background: rgba(224, 0, 0, 0.4);
            transform: rotate(90deg);
        }

        #userList {
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
        }

        #userList::-webkit-scrollbar {
            width: 6px;
        }

        #userList::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        #userList::-webkit-scrollbar-thumb {
            background: rgba(224, 0, 0, 0.4);
            border-radius: 10px;
        }

        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .user-item:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(224, 0, 0, 0.3);
            transform: translateX(5px);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, #e00000, #ff6347);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: white;
        }

        .user-info span {
            color: white;
            font-weight: 500;
        }

        .btn-chat {
            padding: 8px 20px;
            background: linear-gradient(45deg, #e00000, #ff6347);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-chat:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(224, 0, 0, 0.4);
        }

        .file-dialog {
            padding: 30px;
        }

        .file-dialog-info {
            margin-bottom: 25px;
        }

        .file-dialog-info p {
            color: #ccc;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .file-dialog-info strong {
            color: white;
        }

        .file-dialog-buttons {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }

        .btn-dialog {
            padding: 12px 30px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-dialog.primary {
            background: linear-gradient(45deg, #e00000, #ff6347);
            border: none;
            color: white;
        }

        .btn-dialog.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(224, 0, 0, 0.4);
        }

        .btn-dialog.secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            color: white;
        }

        .btn-dialog.secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .language-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(224, 0, 0, 0.2);
            border: 2px solid rgba(224, 0, 0, 0.3);
            border-radius: 25px;
            padding: 8px 16px;
            color: white;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .language-toggle:hover {
            background: rgba(224, 0, 0, 0.3);
            border-color: #e00000;
            transform: translateY(-2px);
        }

        body.tamil {
            font-family: 'Anek Tamil', sans-serif;
            font-weight: 500;
            line-height: 1.65;
        }

        .preview-close {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background: rgba(0, 0, 0, 0.6);
            color: #fff;
            font-size: 18px;
            cursor: pointer;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .preview-close:hover {
            background: rgba(0, 0, 0, 0.85);
        }

        .preview-wrapper {
            position: relative;
        }


        .btn-call {
            padding: 8px 16px;
            background: rgba(34, 197, 94, 0.2);
            border: 2px solid #22c55e;
            border-radius: 8px;
            color: #22c55e;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-call:hover {
            background: rgba(34, 197, 94, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(34, 197, 94, 0.3);
        }

        .user-actions {
            display: flex;
            gap: 8px;
        }


        .call-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(10px);
        }

        .call-container {
            background: rgba(20, 20, 20, 0.98);
            border-radius: 30px;
            border: 2px solid rgba(224, 0, 0, 0.3);
            padding: 40px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            animation: callSlideIn 0.4s ease-out;
        }

        @keyframes callSlideIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .call-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(45deg, #e00000, #ff6347);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            font-weight: 700;
            color: white;
            margin: 0 auto 20px;
            animation: avatarPulse 2s infinite;
        }

        @keyframes avatarPulse {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(224, 0, 0, 0.7);
            }

            50% {
                box-shadow: 0 0 0 20px rgba(224, 0, 0, 0);
            }
        }

        .call-name {
            font-size: 28px;
            font-weight: 700;
            color: white;
            margin-bottom: 10px;
        }

        .call-status {
            font-size: 16px;
            color: #aaa;
            margin-bottom: 30px;
        }

        .call-timer {
            font-size: 24px;
            color: #22c55e;
            font-weight: 600;
            margin-bottom: 30px;
            font-family: 'Courier New', monospace;
        }

        .call-controls {
            display: flex;
            gap: 20px;
            justify-content: center;
            align-items: center;
        }

        .call-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
        }

        .call-btn.mute {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .call-btn.mute:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .call-btn.mute.active {
            background: rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }

        .call-btn.end {
            background: linear-gradient(45deg, #dc2626, #ef4444);
            color: white;
        }

        .call-btn.end:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 25px rgba(220, 38, 38, 0.5);
        }

        .call-btn.accept {
            background: linear-gradient(45deg, #16a34a, #22c55e);
            color: white;
        }

        .call-btn.accept:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 25px rgba(22, 163, 74, 0.5);
        }

        .call-btn.reject {
            background: linear-gradient(45deg, #dc2626, #ef4444);
            color: white;
        }

        .call-btn.reject:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 25px rgba(220, 38, 38, 0.5);
        }

        .btn-call:disabled {
            background: rgba(100, 116, 139, 0.15);
            border-color: rgba(100, 116, 139, 0.3);
            color: #94a3b8;
        }

        .incoming-call-controls {
            display: flex;
            gap: 20px;
            justify-content: center;
        }

        .btn-video-call {
            background: rgba(59, 130, 246, 0.2);
            border: 2px solid #3b82f6;
            color: #3b82f6;
        }

        #videoContainer {
            position: relative;
            width: 100%;
            height: 100%;
            max-width: none;
            margin: 0;
            border-radius: 0;
            overflow: hidden;
            background: #000;
        }

        #remoteVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 0;
            display: block;
        }

        #localVideo {
            position: absolute;
            bottom: 100px;
            right: 15px;
            width: 80px;
            height: 106px;
            border-radius: 10px;
            border: 2px solid white;
            object-fit: cover;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            z-index: 10;
        }


        @keyframes fadeSlideUp {
            from {
                opacity: 0;
                transform: translateY(15px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulseGlow {

            0%,
            100% {
                opacity: 1;
                box-shadow: 0 0 5px #e00000;
            }

            50% {
                opacity: 0.5;
                box-shadow: 0 0 10px #e00000;
            }
        }

        #infoModal .modal-content {
            max-width: 550px;
            width: 92%;
        }

        #infoModalContent {
            padding: 20px 25px;
            font-size: 14px;
            line-height: 1.7;
            color: #e0e0e0;
        }

        #infoModalContent b {
            color: #fff;
            font-weight: 600;
        }

        .info-modal-footer {
            padding: 15px 25px;
            text-align: right;
            border-top: 2px solid rgba(224, 0, 0, 0.2);
        }

        .file-progress {
            position: fixed;
            bottom: 100px;
            right: 30px;
            background: rgba(20, 20, 20, 0.95);
            border: 2px solid rgba(224, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            min-width: 300px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            color: white;
            font-size: 14px;
        }

        .progress-bar-container {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(45deg, #e00000, #ff6347);
            border-radius: 10px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-info {
            color: #aaa;
            font-size: 12px;
        }

        .progress-cancel {
            background: rgba(239, 68, 68, 0.2);
            border: none;
            color: #ef4444;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .progress-percent-row {
            text-align: right;
            color: #22c55e;
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 8px;
        }

        #fileModal .modal-content {
            position: absolute;
            cursor: grab;
            touch-action: none;
        }

        .progress-close {
            background: rgba(255, 255, 255, 0.15);
            border: none;
            color: #ccc;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .progress-close:hover {
            background: rgba(255, 255, 255, 0.25);
        }




        body.light-theme {
            background: #f5f7fa;
            color: #1a1a1a;
        }

        body.light-theme #loginScreen {
            background: linear-gradient(135deg, #e3e8ef 0%, #f5f7fa 100%);
        }

        body.light-theme .login-container {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(100, 116, 139, 0.2);
            box-shadow: 0 20px 60px rgba(100, 116, 139, 0.15);
        }

        body.light-theme .login-icon {
            border: 2px solid #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        body.light-theme .login-header h1 {
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        body.light-theme .login-header p {
            color: #64748b;
        }

        body.light-theme .form-group label {
            color: #1a1a1a;
        }

        body.light-theme .form-group input {
            background: rgba(100, 116, 139, 0.05);
            border: 2px solid rgba(100, 116, 139, 0.2);
            color: #1a1a1a;
        }

        body.light-theme .form-group input::placeholder {
            color: #94a3b8;
        }

        body.light-theme .form-group input:focus {
            border-color: #667eea;
            background: rgba(100, 116, 139, 0.08);
        }

        body.light-theme .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
        }

        body.light-theme .btn-primary:hover {
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        body.light-theme .info-text {
            color: #64748b;
        }

        body.light-theme #chatScreen {
            background: #f5f7fa;
        }

        body.light-theme .chat-header {
            background: rgba(255, 255, 255, 0.95);
            border-bottom: 2px solid rgba(100, 116, 139, 0.2);
        }

        body.light-theme .chat-header-left h2 {
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        body.light-theme .chat-status {
            color: #64748b;
        }

        body.light-theme .status-dot {
            background: #10b981;
            box-shadow: 0 0 5px #10b981;
        }

        body.light-theme .btn-secondary {
            background: rgba(102, 126, 234, 0.1);
            border: 2px solid rgba(102, 126, 234, 0.3);
            color: #667eea;
        }

        body.light-theme .btn-secondary:hover {
            background: rgba(102, 126, 234, 0.2);
            border-color: #667eea;
        }

        body.light-theme .messages-container {
            background: #f5f7fa;
            background-image:
                radial-gradient(circle at 20% 50%, rgba(102, 126, 234, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(118, 75, 162, 0.05) 0%, transparent 50%);
        }

        body.light-theme .messages-container::-webkit-scrollbar-track {
            background: rgba(100, 116, 139, 0.1);
        }

        body.light-theme .messages-container::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.3);
        }

        body.light-theme .messages-container::-webkit-scrollbar-thumb:hover {
            background: rgba(102, 126, 234, 0.5);
        }

        body.light-theme .message.received .message-bubble {
            background: white;
            color: #1a1a1a;
            border: 1px solid rgba(100, 116, 139, 0.2);
        }

        body.light-theme .message.sent .message-bubble {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        body.light-theme .message.private .message-bubble {
            background: rgba(251, 191, 36, 0.1);
            border: 2px solid #fbbf24;
            color: #d97706;
        }

        body.light-theme .message.system .message-bubble {
            background: rgba(100, 116, 139, 0.1);
            color: #64748b;
        }

        body.light-theme .input-container {
            background: rgba(255, 255, 255, 0.95);
            border-top: 2px solid rgba(100, 116, 139, 0.2);
        }

        body.light-theme .btn-icon {
            background: rgba(102, 126, 234, 0.1);
            border: 2px solid rgba(102, 126, 234, 0.2);
            color: #667eea;
        }

        body.light-theme .btn-icon:hover {
            background: rgba(102, 126, 234, 0.2);
        }

        body.light-theme #messageInput {
            background: rgba(100, 116, 139, 0.05);
            border: 2px solid rgba(100, 116, 139, 0.2);
            color: #1a1a1a;
        }

        body.light-theme #messageInput::placeholder {
            color: #94a3b8;
        }

        body.light-theme #messageInput:focus {
            border-color: #667eea;
            background: rgba(100, 116, 139, 0.08);
        }

        body.light-theme .btn-send {
            background: linear-gradient(45deg, #667eea, #764ba2);
        }

        body.light-theme .btn-send:hover {
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        body.light-theme .modal {
            background: rgba(0, 0, 0, 0.5);
        }

        body.light-theme .modal-content {
            background: rgba(255, 255, 255, 0.98);
            border: 2px solid rgba(100, 116, 139, 0.2);
        }

        body.light-theme .modal-header {
            border-bottom: 2px solid rgba(100, 116, 139, 0.15);
        }

        body.light-theme .modal-header h3 {
            color: #1a1a1a;
        }

        body.light-theme .btn-close {
            background: rgba(100, 116, 139, 0.1);
            color: #64748b;
        }

        body.light-theme .btn-close:hover {
            background: rgba(100, 116, 139, 0.2);
        }

        body.light-theme #userList::-webkit-scrollbar-track {
            background: rgba(100, 116, 139, 0.05);
        }

        body.light-theme #userList::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.3);
        }

        body.light-theme .user-item {
            background: rgba(100, 116, 139, 0.05);
            border: 1px solid rgba(100, 116, 139, 0.15);
        }

        body.light-theme .user-item:hover {
            background: rgba(100, 116, 139, 0.1);
            border-color: rgba(102, 126, 234, 0.3);
        }

        body.light-theme .user-avatar {
            background: linear-gradient(45deg, #667eea, #764ba2);
        }

        body.light-theme .user-info span {
            color: #1a1a1a;
        }

        body.light-theme .btn-chat {
            background: linear-gradient(45deg, #667eea, #764ba2);
        }

        body.light-theme .btn-chat:hover {
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        body.light-theme .file-dialog-info p {
            color: #475569;
        }

        body.light-theme .file-dialog-info strong {
            color: #1a1a1a;
        }

        body.light-theme .btn-dialog.primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
        }

        body.light-theme .btn-dialog.primary:hover {
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        body.light-theme .btn-dialog.secondary {
            background: rgba(100, 116, 139, 0.1);
            border: 2px solid rgba(100, 116, 139, 0.2);
            color: #475569;
        }

        body.light-theme .btn-dialog.secondary:hover {
            background: rgba(100, 116, 139, 0.15);
        }

        body.light-theme .language-toggle {
            background: rgba(102, 126, 234, 0.1);
            border-color: rgba(102, 126, 234, 0.3);
            color: #667eea;
        }

        body.light-theme .language-toggle:hover {
            background: rgba(102, 126, 234, 0.2);
            border-color: #667eea;
        }

        body.light-theme #messageInput::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.35);
        }

        body.light-theme #messageInput::-webkit-scrollbar-thumb:hover {
            background: rgba(102, 126, 234, 0.6);
        }

        body.light-theme #messageInput {
            scrollbar-color: rgba(102, 126, 234, 0.45) transparent;
        }

        /* Add these inside body.light-theme { } section */

        body.light-theme .btn-call {
            background: rgba(34, 197, 94, 0.1);
            border-color: #22c55e;
            color: #16a34a;
        }

        body.light-theme .btn-call:hover {
            background: rgba(34, 197, 94, 0.2);
        }

        body.light-theme .call-modal {
            background: rgba(255, 255, 255, 0.95);
        }

        body.light-theme .call-container {
            background: rgba(255, 255, 255, 0.98);
            border: 2px solid rgba(100, 116, 139, 0.2);
        }

        body.light-theme .call-avatar {
            background: linear-gradient(45deg, #667eea, #764ba2);
        }

        body.light-theme .call-name {
            color: #1a1a1a;
        }

        body.light-theme .call-status {
            color: #64748b;
        }

        body.light-theme .call-btn.mute {
            background: rgba(100, 116, 139, 0.1);
            color: #475569;
        }

        body.light-theme .call-btn.mute:hover {
            background: rgba(100, 116, 139, 0.2);
        }

        body.light-theme .btn-video-call {
            background: rgba(59, 130, 246, 0.1);
            border-color: #3b82f6;
            color: #2563eb;
        }

        body.light-theme .btn-video-call:hover {
            background: rgba(59, 130, 246, 0.2);
        }

        body.light-theme #infoModalContent {
            color: #475569;
        }

        body.light-theme #infoModalContent b {
            color: #1a1a1a;
        }

        body.light-theme .info-modal-footer {
            border-top: 2px solid rgba(100, 116, 139, 0.15);
        }

        #infoModalContent::-webkit-scrollbar {
            width: 6px;
        }

        #infoModalContent::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        #infoModalContent::-webkit-scrollbar-thumb {
            background: rgba(224, 0, 0, 0.4);
            border-radius: 10px;
        }

        body.light-theme #infoModalContent::-webkit-scrollbar-track {
            background: rgba(100, 116, 139, 0.05);
        }

        body.light-theme #infoModalContent::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.3);
        }

        body.light-theme .file-progress {
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid rgba(100, 116, 139, 0.3);
        }

        body.light-theme .progress-bar {
            background: linear-gradient(45deg, #667eea, #764ba2);
        }

        .language-toggle {
            top: 15px;
            right: 15px;
            padding: 6px 12px;
            font-size: 12px;
        }


        @media (max-width: 768px) {

            html,
            body {
                height: 100%;
                overflow: hidden;
            }

            #chatScreen {
                display: none;
                flex-direction: column;
                height: 100dvh;
                width: 100%;
                position: relative;
            }

            .login-container {
                padding: 35px 25px;
                margin: 15px;
            }

            .login-icon {
                width: 70px;
                height: 70px;
                font-size: 35px;
            }

            .login-header h1 {
                font-size: 26px;
            }


            .chat-header {
                display: flex;
                align-items: center;
                justify-content: space-between;

                padding: 8px 14px;
                gap: 10px;
                flex-shrink: 0;
            }

            .chat-header-left {
                flex: 1;
                min-width: 0;
            }

            .chat-header-left h2 {
                font-size: 16px;
                line-height: 1.2;
                margin-bottom: 2px;
            }

            .chat-status {
                font-size: 11px;
            }


            .chat-header-right {
                display: flex;
                align-items: flex-start;
                gap: 12px;
            }


            .icon-btn {
                display: inline-flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 8px 10px;
                gap: 4px;
                border-radius: 12px;
                border: 1px solid rgba(224, 0, 0, 0.45);
                background: rgba(224, 0, 0, 0.08);
                white-space: nowrap;
            }

            .icon-btn .icon {
                font-size: 18px;
                line-height: 1;
            }

            .icon-btn .label {
                font-size: 11px;
                font-weight: 500;
                line-height: 1.1;
                text-align: center;
                white-space: nowrap;
                color: #555;
            }


            .messages-container {
                flex: 1;
                padding: 20px 15px;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }

            .message-bubble {
                max-width: 80%;
                font-size: 14px;
                padding: 10px 15px;
            }

            .message.system .message-bubble {
                max-width: 90%;
            }

            .input-container {
                display: flex;
                align-items: center;
                gap: 10px;

                padding: 15px;
                background: rgba(20, 20, 20, 0.95);
                border-top: 2px solid rgba(224, 0, 0, 0.3);
                flex-shrink: 0;
            }

            .btn-icon,
            .btn-send {
                width: 44px;
                height: 44px;
                font-size: 18px;
                flex-shrink: 0;
            }

            .modal-content {
                width: 95%;
                margin: 10px;
            }

            .modal-header {
                padding: 15px 20px;
            }

            .modal-header h3 {
                font-size: 18px;
            }

            .file-dialog {
                padding: 20px;
            }

            .file-dialog-buttons {
                flex-direction: column;
            }

            .btn-dialog {
                width: 100%;
            }

            .user-item {
                padding: 12px;
            }

            .user-avatar {
                width: 35px;
                height: 35px;
                font-size: 14px;
            }

            .btn-chat {
                padding: 6px 15px;
                font-size: 12px;
            }

            .preview-wrapper {
                padding: 9px;
                border-radius: 13px;
            }

            .preview-content {
                max-height: 70vh;
                border-radius: 11px;
            }

            .preview-content iframe {
                height: 260px;
            }

            .preview-content pre {
                font-size: 13px;
                line-height: 1.45;
            }

            .preview-content img {
                width: 100%;
                max-height: 70vh;
                object-fit: contain;
            }

            .preview-content iframe {
                width: 100%;
                height: 65vh;
                border: none;
            }

            .preview-content pre {
                max-height: 70vh;
                overflow: auto;
                font-size: 13px;
                line-height: 1.5;
            }

            .call-container {
                padding: 30px 25px;
                max-width: 95%;
            }

            .call-avatar {
                width: 100px;
                height: 100px;
                font-size: 40px;
            }

            .call-name {
                font-size: 24px;
            }

            .call-status {
                font-size: 14px;
            }

            .call-timer {
                font-size: 20px;
            }

            .call-btn {
                width: 60px;
                height: 60px;
                font-size: 24px;
            }

            .user-item {
                padding: 12px;
                flex-wrap: wrap;
            }

            .user-actions {
                width: 100%;
                margin-top: 10px;
                justify-content: flex-end;
            }

            .btn-chat,
            .btn-call {
                padding: 6px 15px;
                font-size: 12px;
            }

            #localVideo {
                width: 70px;
                height: 93px;
                bottom: 90px;
                right: 12px;
            }

            #infoModal .modal-content {
                width: 95%;
                max-height: 85vh;
            }

            #infoModalContent {
                padding: 18px 20px;
                font-size: 13px;
                line-height: 1.65;
                max-height: calc(85vh - 140px);
                overflow-y: auto;
            }

            .info-modal-footer {
                padding: 12px 20px;
            }

            .info-modal-footer .btn-dialog {
                width: 100%;
                padding: 14px 20px;
            }

            .file-progress {
                bottom: 80px;
                right: 15px;
                left: 15px;
                min-width: auto;
                max-width: calc(100% - 30px);
                padding: 15px;
            }

            .progress-header {
                font-size: 12px;
            }

            .progress-info {
                font-size: 11px;
            }
        }


        @media (max-width: 480px) {

            html,
            body {
                height: 100%;
                overflow: hidden;
            }

            .btn-primary {
                padding: 10px;
                border-radius: 12px;
                font-size: 14px;
                font-weight: 600;
            }

            #chatScreen {
                display: flex;
                flex-direction: column;
                height: 100dvh;
                width: 100%;
            }

            .chat-header {
                padding: 6px 10px;
                gap: 6px;
            }

            .chat-header-left h2 {
                font-size: 15px;
                font-weight: 600;
            }

            .chat-status {
                font-size: 10px;
                opacity: 0.75;
            }

            .chat-header-right {
                display: flex;
                align-items: center;
                gap: 6px;
            }

            .chat-header-right {
                gap: 8px;
            }

            .icon-btn {
                padding: 6px;
                min-width: 38px;
                min-height: 38px;
                border-radius: 10px;
            }

            .icon-btn .label {
                font-size: 8px;
                font-weight: 400;
            }

            .icon-btn .icon {
                font-size: 16px;
            }

            .messages-container {
                flex: 1;
                min-height: 0;
                padding: 14px 10px;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }

            .message-bubble {
                max-width: 86%;
                font-size: 12.5px;
                padding: 9px 13px;
                border-radius: 16px;
            }

            .message.system .message-bubble {
                max-width: 92%;
                font-size: 12px;
            }


            .input-container {
                display: flex;
                align-items: center;
                gap: 8px;
                padding: 10px;
                background: rgba(20, 20, 20, 0.95);
                border-top: 1px solid rgba(224, 0, 0, 0.25);
            }

            .btn-icon,
            .btn-send {
                width: 40px;
                height: 40px;
                font-size: 17px;
                flex-shrink: 0;
            }

            .form-group input {
                padding: 13px;
                font-size: 13px;
            }

            #messageInput {
                font-size: 13px;
                line-height: 1.4;
                max-height: 110px;
            }

            .input-container {
                padding-bottom: max(10px, env(safe-area-inset-bottom));
            }

            .input-container {
                padding-bottom: max(12px, env(safe-area-inset-bottom));
            }

            .modal-content {
                width: 94%;
                margin: 8px;
                border-radius: 16px;
            }

            .modal-header {
                padding: 12px 16px;
            }

            .modal-header h3 {
                font-size: 16px;
            }

            .user-item {
                padding: 10px;
            }

            .user-avatar {
                width: 32px;
                height: 32px;
                font-size: 13px;
            }

            .btn-chat {
                padding: 5px 12px;
                font-size: 11px;
                border-radius: 6px;
            }

            #previewModal .modal-content {
                width: 96%;
                max-height: 92vh;
                margin: 8px;
            }

            .preview-content img {
                width: 100%;
                max-height: 78vh;
                object-fit: contain;
            }

            #previewModalContent {
                padding: 10px;
            }

            .preview-wrapper {
                padding: 8px;
                border-radius: 12px;
            }

            .preview-content {
                max-height: 78vh;
                border-radius: 10px;
            }

            .preview-content pre {
                max-height: 78vh;
                font-size: 12px;
                line-height: 1.45;
                overflow: auto;
            }

            .preview-content iframe {
                width: 100%;
                height: 72vh;
                border: none;
            }

            .call-container {
                padding: 25px 20px;
            }

            .call-avatar {
                width: 90px;
                height: 90px;
                font-size: 36px;
            }

            .call-name {
                font-size: 20px;
            }

            .call-status {
                font-size: 13px;
            }

            .call-timer {
                font-size: 18px;
            }

            .call-btn {
                width: 55px;
                height: 55px;
                font-size: 22px;
            }

            .call-controls {
                gap: 15px;
            }

            .btn-chat,
            .btn-call {
                padding: 5px 12px;
                font-size: 11px;
                border-radius: 6px;
            }

            #localVideo {
                width: 65px;
                height: 87px;
                bottom: 85px;
                right: 10px;
                border-radius: 8px;
            }

            #infoModal .modal-content {
                width: 96%;
                max-height: 88vh;
                margin: 10px;
            }

            #infoModalContent {
                padding: 16px 18px;
                font-size: 12.5px;
                line-height: 1.6;
                max-height: calc(88vh - 130px);
            }

            .info-modal-footer {
                padding: 10px 18px;
            }

            .info-modal-footer .btn-dialog {
                padding: 12px 18px;
                font-size: 13px;
            }

            .file-progress {
                bottom: 70px;
                right: 10px;
                left: 10px;
                padding: 12px;
            }

            .progress-header {
                font-size: 11px;
            }
        }

        @media (hover: hover) and (pointer: fine) {

            #previewModal {
                align-items: center;
                justify-content: center;
            }

            #previewModal .modal-content {
                width: 90vw;
                max-width: 1200px;
                max-height: 90vh;
                height: auto;
                display: flex;
                flex-direction: column;
            }

            #previewModalContent {
                padding: 12px;
                flex: 1;
                overflow: hidden;
            }

            .preview-wrapper {
                padding: 0;
                margin: 0;
                border-radius: 14px;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .preview-content {
                width: 100%;
                height: 100%;
                max-height: 85vh;
                display: flex;
                align-items: center;
                justify-content: center;
                overflow: auto;
            }


            .preview-content img {
                max-width: 100%;
                max-height: 85vh;
                width: auto;
                height: auto;
                object-fit: contain;
                display: block;
                margin: auto;
            }


            .preview-content iframe {
                width: 100%;
                height: 85vh;
                border: none;
                background: #fff;
            }
        }


        @media (max-width: 768px) and (orientation: landscape) {
            .chat-header {
                padding: 10px 15px;
            }

            .messages-container {
                padding: 15px;
            }

            .input-container {
                padding: 10px 15px;
            }

            .btn-send,
            .btn-icon {
                width: 40px;
                height: 40px;
            }

            .call-container {
                padding: 20px;
            }

            .call-avatar {
                width: 80px;
                height: 80px;
                font-size: 32px;
            }
        }

        @media (max-width: 768px) {
            body.light-theme #messageInput {
                background: rgba(100, 116, 139, 0.05);
                border: 2px solid rgba(100, 116, 139, 0.2);
                color: #1a1a1a;
            }

            body.light-theme .input-container {
                background: rgba(255, 255, 255, 0.95);
                border-top: 2px solid rgba(100, 116, 139, 0.2);
            }
        }

        @media (prefers-reduced-motion: reduce) {

            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }


        body.light-theme button:focus-visible,
        body.light-theme input:focus-visible {
            outline-color: #667eea;
        }

        @supports (padding: max(0px)) {
            .input-container {
                padding-bottom: max(15px, env(safe-area-inset-bottom));
            }
        }

        body.keyboard-open {
            overflow: hidden;
            position: fixed;
            width: 100%;
        }
    </style>
</head>

<body>
    <div id="loginScreen">
        <div class="login-container">
            <button class="language-toggle" onclick="toggleLanguage()">
                <span id="langToggleText">English</span>
            </button>
            <div class="login-header">
                <div class="login-icon">💬</div>
                <h1 id="appTitle">அரட்டை</h1>
                <p id="appSubtitle">வாங்க… பேசலாம்😊</p>
            </div>

            <div class="form-group">
                <label id="usernameLabel">உங்கள் பெயர்</label>
                <input type="text" id="usernameInput" placeholder="பயனர் பெயரை உள்ளிடுங்கள்">
            </div>

            <button class="btn-primary" onclick="connect()" id="connectBtn">Connect</button>

            <!-- <p class="info-text">கட்டளைகள்: /list • /chat [user] • /group</p> -->
            <p class="info-text" id="infoText" style="margin-top: 10px; font-size: 11px;">
                💡 தகவல்: இது ஒரு தனிப்பட்ட உரையாடல். பக்கத்தை புதுப்பித்தால் புதிய உரையாடல் தொடங்கும்.
            </p>
        </div>
    </div>

    <div id="chatScreen">
        <div class="chat-header">
            <div class="chat-header-left">
                <h2 id="chatTitle">அரட்டை</h2>
                <div class="chat-status">
                    <div class="status-dot"></div>
                    <span id="statusText" lang="ta">இணைக்கப்படுகிறது...</span>
                </div>
            </div>
            <div class="chat-header-right" lang="ta">
                <button class="btn-secondary icon-btn" onclick="showUserList()">
                    <span class="icon">👥</span>
                    <span class="label" id="usersBtnText">உறுப்பினர்கள்</span>
                </button>

                <button class="btn-secondary icon-btn" onclick="enableGroupChat()">
                    <span class="icon">🌍</span>
                    <span class="label" id="groupBtnText">குழுமம்</span>
                </button>

                <button class="btn-secondary icon-btn" onclick="toggleTheme()">
                    <span class="icon">🎨</span>
                    <span class="label" id="themeBtnText">தோற்றம்</span>
                </button>

                <button class="btn-secondary icon-btn" onclick="toggleLanguage()">
                    <span class="icon">🌐</span>
                    <span class="label" id="langToggleChatText">English</span>
                </button>

            </div>

        </div>

        <div class="messages-container" id="messagesContainer"></div>

        <div class="input-container">
            <input type="file" id="fileInput" multiple style="display: none;" onchange="handleFileSelect(event)">
            <button class="btn-icon" onclick="document.getElementById('fileInput').click()">
                📎
            </button>
            <textarea id="messageInput" placeholder="Type a message..." rows="1"></textarea>
            <button class="btn-send" onclick="sendMessage()">
                ➤
            </button>
        </div>
    </div>

    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">தற்போது இணைந்துள்ள பயனர்கள்</h3>
                <button class="btn-close" onclick="closeUserModal()">×</button>
            </div>
            <div id="userList"></div>
        </div>
    </div>

    <div id="fileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="fileModalTitle">Incoming File</h3>
                <button class="btn-close" onclick="closeFileDialog(false,'','')">×</button>
            </div>
            <div id="fileDialogContent" class="file-dialog"></div>
        </div>
    </div>

    <div id="previewModal" class="modal">
        <div class="modal-content" style="max-width:700px;">
            <div class="modal-header">
                <h3>File Preview</h3>
                <button class="btn-close" onclick="closePreviewModal()">×</button>
            </div>
            <div id="previewModalContent" style="padding:20px;"></div>
        </div>
    </div>


    <div id="callModal" class="call-modal">
        <div class="call-container">
            <div class="call-avatar" id="callAvatar">A</div>
            <div id="videoContainer" style="display: none;">
                <video id="remoteVideo" autoplay playsinline style="width: 100%; border-radius: 20px;"></video>
                <video id="localVideo" autoplay muted playsinline></video>
            </div>
            <div class="call-name" id="callName">User</div>
            <div class="call-status" id="callStatus">Calling...</div>
            <div class="call-timer" id="callTimer" style="display: none;">00:00</div>

            <div class="call-controls" id="activeCallControls" style="display: none;">
                <button class="call-btn mute" id="muteBtn" onclick="toggleMute()">
                    🎤
                </button>
                <button class="call-btn mute" id="cameraBtn" onclick="toggleCamera()" style="display: none;">
                    📹
                </button>
                <button class="call-btn mute" id="speakerBtn" onclick="toggleSpeaker()">
                    🔊
                </button>
                <button class="call-btn end" onclick="endCall()">
                    📞
                </button>
            </div>

            <div class="incoming-call-controls" id="incomingCallControls" style="display: none;">
                <button class="call-btn reject" onclick="rejectCall()">
                    📞
                </button>
                <button class="call-btn accept" onclick="acceptCall()">
                    📞
                </button>
            </div>
        </div>
    </div>

    <div id="infoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="infoModalTitle">ℹ️ தகவல்</h3>
                <button class="btn-close" onclick="closeInfoModal()">×</button>
            </div>
            <div style="padding:20px;font-size:14px;line-height:1.6;" id="infoModalContent"></div>

            <div class="info-modal-footer">
                <button id="infoModalBtn" class="btn-dialog primary" onclick="closeInfoModal()">
                    👍 புரிந்தது
                </button>
            </div>
        </div>
    </div>

    <div id="fileProgress" class="file-progress">
        <div class="progress-header">
            <span id="progressFileName">Sending file...</span>
            <div style="display:flex; gap:6px;">
                <button class="progress-cancel" onclick="cancelFileTransfer()">✕</button>
                <button class="progress-close" onclick="hideProgress()">—</button>
            </div>
        </div>
        <div class="progress-percent-row">
            <span id="progressPercent">0%</span>
        </div>
        <div class="progress-bar-container">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        <div class="progress-info" id="progressInfo">0 / 0 chunks</div>
    </div>



    <audio id="remoteAudio" autoplay></audio>

    <script>
        let ws = null;
        let username = '';
        let isSpeakerOn = true;
        let currentMode = 'group';
        let privateReceiver = '';
        let onlineUsers = [];
        let currentLanguage = 'ta';
        let receivingFile = false;
        let receivedChunks = [];
        let totalChunksExpected = 0;
        let currentFileName = '';
        let currentFileSender = '';
        let currentFileSize = 0;

        const textarea = document.getElementById('messageInput');
        const remoteVideo = document.getElementById('remoteVideo');
        const localVideo = document.getElementById('localVideo');
        const remoteAudio = document.getElementById('remoteAudio');


        let peerConnection = null;
        let localStream = null;
        let callTimer = null;
        let callStartTime = null;
        let isMuted = false;
        let currentCallUser = '';
        let isCallInitiator = false;
        let myCountryCode = null;
        let isVideoCall = false;
        let localVideoStream = null;
        let cameraEnabled = true;
        let sendProgress = 0;
        let receiveProgress = 0;
        let progressInterval = null;
        let transferCancelled = false;
        let fileQueue = [];
        let isShowingFileDialog = false;

        const translations = {
            en: {
                appTitle: 'Chat Application',
                appSubtitle: 'Hey… lets talk😊',
                usernameLabel: 'Username',
                usernamePlaceholder: 'Enter your username',
                infoText: '💡 Info: This is a private chat. Refreshing the page will start a new conversation.',
                langToggle: 'தமிழ்',
                chatTitle: 'Chat Application',
                connecting: 'Connecting...',
                usersBtn: 'Users',
                groupBtn: 'Group',
                themeBtn: 'Theme',
                modalTitle: 'Online Users',
                groupChat: 'Group Chat',
                privateChat: 'Private with',
                connectedSuccess: 'Connected successfully!',
                userJoined: 'joined the chat',
                userLeft: 'left the chat',
                switchedToGroup: 'Switched to group chat',
                enterNameAlert: 'Please enter your name',
                unknownCommand: 'Unknown command',
                notConnected: 'Not connected to server',
                file: '📎 File',
                fileSaved: ' - saved successfully',
                fileNotSaved: ' - was not saved',
                largeFileSending: 'Large file is being sent : ',
                pleaseWait: ' Please wait...',
                incomingFile: 'Incoming File',
                receivedFile: 'Received file',
                fileSize: 'Size',
                sender: 'Sender',
                saveFileConfirm: 'Do you want to save this file?',
                yes: 'Yes',
                no: 'No',
                connectBtn: 'Connect',
                typeMessage: 'Type a message...',
                chatBtn: 'Chat',
                incomingFileTitle: 'Incoming File',
                connectionError: 'Connection error occurred',
                disconnected: 'Disconnected',
                fileSent: '📎 File sent',
                fileReadError: 'Failed to read file',
                callBtn: 'Call',
                incomingCall: 'Incoming call... ',
                isCalligYou: ' is calling you',
                connected: 'Connected',
                callEnded: 'Call ended',
                callRejected: 'rejected the call',
                micPermissionDenied: 'Microphone permission denied',
                inCall: 'In Call',
                mute: 'Mute',
                unmute: 'Unmute',
                speaker: 'Speaker',
                endCall: 'End Call',
                acceptCall: 'Accept',
                rejectCall: 'Reject',
                calling: 'Calling...',
                busy: 'Busy',
                countryBlocked: '📵 Call blocked: users are in different countries',
                infoModalTitle: 'ℹ️ Information',
                gotIt: '👍 Got it',
                you: 'You',
                receivingFileFrom: 'Receiving',
                from: 'from',
                fileTransferCancelled: 'File transfer cancelled',
                fileTransferCancelledBySender: 'File transfer cancelled by sender',
                fileTransferIncomplete: 'File transfer incomplete',
                sending: 'Sending',
                receiving: 'Receiving',
                previewNotAvailable: 'Preview not available',
                downloadToView: 'Please download to view',
                previewError: 'Error loading file preview',
                sendingFile: 'Sending',
                downloadPdf: 'Download PDF',
                preview: 'Preview',
                filePreviewTitle: 'File Preview',
                speakerNotSupported: 'Speaker switching is not supported in this browser.',
                noAudioOutput: 'No audio output devices found',
                connectionFailed: 'Failed to connect',
                chunks: 'chunks',
                callTimedOut: 'Call timed out'

            },
            ta: {
                appTitle: 'அரட்டை',
                appSubtitle: 'வாங்க… பேசலாம்😊',
                usernameLabel: 'உங்கள் பெயர்',
                usernamePlaceholder: 'பயனர் பெயரை உள்ளிடுங்கள்',
                infoText: '💡 தகவல்: இது ஒரு தனிப்பட்ட உரையாடல். பக்கத்தை புதுப்பித்தால் புதிய உரையாடல் தொடங்கும்.',
                langToggle: 'English',
                chatTitle: 'அரட்டை',
                connecting: 'இணைக்கப்படுகிறது...',
                usersBtn: 'உறுப்பினர்கள்',
                groupBtn: 'குழுமம்',
                themeBtn: 'தோற்றம்',
                modalTitle: 'தற்போது இணைந்துள்ள பயனர்கள்',
                groupChat: 'குழு உரையாடல்',
                privateChat: 'உடன் தனிப்பட்ட உரையாடல்',
                connectedSuccess: 'வெற்றிகரமாக இணைக்கப்பட்டது!',
                userJoined: 'அரட்டையில் சேர்ந்தார்',
                userLeft: 'அரட்டையிலிருந்து வெளியேறினார்',
                switchedToGroup: 'குழு உரையாடலுக்கு மாற்றப்பட்டது',
                enterNameAlert: 'தயவுசெய்து உங்கள் பெயரை உள்ளிடுங்கள்',
                unknownCommand: 'அறியப்படாத கட்டளை',
                notConnected: 'சர்வருடன் இணைக்கப்படவில்லை',
                file: '📎 கோப்பு',
                fileSaved: ' - வெற்றிகரமாக சேமிக்கப்பட்டது',
                fileNotSaved: ' - சேமிக்கப்படவில்லை',
                largeFileSending: 'பெரிய கோப்பு அனுப்பப்படுகிறது : ',
                pleaseWait: ' தயவுசெய்து காத்திருக்கவும்...',
                incomingFile: 'உள்வரும் கோப்பு',
                receivedFile: 'கோப்பு பெறப்பட்டது',
                fileSize: 'அளவு',
                sender: 'அனுப்பியவர்',
                saveFileConfirm: 'கோப்பை சேமிக்க வேண்டுமா?',
                yes: 'ஆம்',
                no: 'இல்லை',
                connectBtn: 'இணைக்கவும்',
                typeMessage: 'செய்தியை உள்ளிடுங்கள்...',
                chatBtn: 'அரட்டை',
                incomingFileTitle: 'உள்வரும் கோப்பு',
                connectionError: 'இணைப்பு பிழை ஏற்பட்டது',
                disconnected: 'துண்டிக்கப்பட்டது',
                fileSent: '📎 கோப்பு அனுப்பப்பட்டது',
                fileReadError: 'கோப்பை படிக்க முடியவில்லை',
                callBtn: 'அழைப்பு',
                incomingCall: 'உள்வரும் அழைப்பு... ',
                isCalligYou: ' உங்களை அழைக்கிறார்கள்',
                connected: 'இணைக்கப்பட்டது',
                callEnded: 'அழைப்பு முடிந்தது',
                callRejected: 'அழைப்பை நிராகரித்தார்',
                micPermissionDenied: 'ஒலிப்பதிவி அனுமதி மறுக்கப்பட்டது',
                inCall: 'அழைப்பில்',
                mute: 'ஒலி நிறுத்து',
                unmute: 'ஒலி இயக்கு',
                speaker: 'ஸ்பீக்கர்',
                endCall: 'அழைப்பை முடி',
                acceptCall: 'ஏற்கவும்',
                rejectCall: 'நிராகரி',
                calling: 'அழைக்கிறது...',
                busy: 'அழைப்பில் உள்ளார்',
                countryBlocked: '📵 நாடு வேறுபாடு காரணமாக அழைப்பு தடுக்கப்பட்டது',
                infoModalTitle: 'ℹ️ தகவல்',
                gotIt: '👍 புரிந்தது',
                you: 'நீங்கள்',
                receivingFileFrom: 'பெறப்படுகிறது',
                from: 'இருந்து',
                fileTransferCancelled: 'கோப்பு அனுப்புதல் ரத்து செய்யப்பட்டது',
                fileTransferCancelledBySender: 'அனுப்புநர் கோப்பு அனுப்புதலை ரத்து செய்தார்',
                fileTransferIncomplete: 'கோப்பு அனுப்புதல் முழுமையடையவில்லை',
                sending: 'அனுப்பப்படுகிறது',
                receiving: 'பெறப்படுகிறது',
                previewNotAvailable: 'முன்னோட்டம் கிடைக்கவில்லை',
                downloadToView: 'பார்க்க பதிவிறக்கம் செய்யவும்',
                previewError: 'முன்னோட்டத்தை ஏற்ற முடியவில்லை',
                sendingFile: 'அனுப்பப்படுகிறது',
                downloadPdf: 'PDF பதிவிறக்கு',
                preview: 'முன்னோட்டம்',
                filePreviewTitle: 'கோப்பு முன்னோட்டம்',
                speakerNotSupported: 'இந்த உலாவியில் ஒலிபெருக்கி மாற்றம் ஆதரிக்கப்படவில்லை.',
                noAudioOutput: 'ஒலி வெளியீட்டு சாதனங்கள் கிடைக்கவில்லை',
                connectionFailed: 'இணைப்பு தோல்வியடைந்தது',
                chunks: 'துண்டுகள்',
                callTimedOut: 'அழைப்பு நேரம் முடிந்தது',
            }

        };

        const configuration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };


        function connect() {
            username = document.getElementById('usernameInput').value.trim();
            const SERVER_URL = "wss://chat-app-backend-6piw.onrender.com";
            const serverUrl = SERVER_URL;

            if (!username) {
                alert(translations[currentLanguage].enterNameAlert);
                return;
            }

            try {
                ws = new WebSocket(serverUrl);

                ws.onopen = () => {
                    ws.send(JSON.stringify({
                        type: 'auth',
                        username: username
                    }));
                };

                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    handleMessage(data);
                };

                ws.onerror = () => {
                    const t = translations[currentLanguage];
                    addMessage('System', t.connectionError, 'system');
                };

                ws.onclose = () => {
                    const t = translations[currentLanguage];
                    addMessage('System', t.disconnected, 'system');
                    document.getElementById('statusText').textContent = t.disconnected;
                    if (peerConnection) {
                        endCall();
                    }
                    location.reload();
                };



            } catch (error) {
                alert(`${translations[currentLanguage].connectionFailed}: ${error.message}`);
            }
        }

        function toggleTheme() {
            document.body.classList.toggle('light-theme');
        }

        function isMobile() {
            return /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
        }


        textarea.addEventListener('keydown', function (e) {

            if (!isMobile() && e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }

        });



        textarea.addEventListener('input', function () {
            textarea.style.height = 'auto';

            const maxHeight = window.innerWidth <= 480 ? 80 : 100;

            if (textarea.scrollHeight > maxHeight) {
                textarea.style.height = maxHeight + 'px';
                textarea.style.overflowY = 'auto';
            } else {
                textarea.style.height = textarea.scrollHeight + 'px';
                textarea.style.overflowY = 'hidden';
            }
        });


        function handleMessage(data) {
            const t = translations[currentLanguage];

            switch (data.type) {
                case 'auth_success':
                    myCountryCode = data.country || null;
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('chatScreen').style.display = 'flex';
                    document.getElementById('statusText').textContent = username + ' • ' + t.groupChat;
                    addMessage('System', t.connectedSuccess, 'system');
                    requestNotificationPermission();

                    setTimeout(showInfoModal, 500);
                    break;
                case 'auth_error':
                    alert(data.message);
                    ws.close();
                    break;
                case 'message':
                    addMessage(data.sender, data.content, 'received');
                    break;
                case 'private_message':
                    addMessage(data.sender, data.content, 'private');
                    break;
                case 'user_joined':
                    addMessage('System', `${data.username} ${t.userJoined}`, 'system');
                    break;
                case 'user_left':
                    addMessage('System', `${data.username} ${t.userLeft}`, 'system');
                    if (data.username === currentCallUser) {
                        endCall();
                    }
                    break;
                case 'user_list':
                    onlineUsers = data.users;
                    displayUserList();
                    break;
                case 'private_enabled':
                    currentMode = 'private';
                    privateReceiver = data.receiver;
                    if (currentLanguage === 'ta') {
                        document.getElementById('statusText').textContent = username + ' • ' + data.receiver + ' ' + t.privateChat;
                    } else {
                        document.getElementById('statusText').textContent = username + ' • ' + t.privateChat + ' ' + data.receiver;
                    }
                    addMessage('System', `${data.receiver} ${t.privateChat}`, 'system');
                    break;
                case 'group_enabled':
                    currentMode = 'group';
                    privateReceiver = '';
                    document.getElementById('statusText').textContent = username + ' • ' + t.groupChat;
                    addMessage('System', t.switchedToGroup, 'system');
                    break;
                case 'file':
                    showFileSaveDialog(data.sender, data.fileName, data.fileData, data.fileSize);
                    break;
                case 'call_request':
                    handleIncomingCall(data.from, data.callType);
                    break;
                case 'call_accepted':
                    handleCallAccepted();
                    break;
                case 'call_rejected':
                    handleCallRejected(data.reason);
                    break;
                case 'call_ended':
                    handleCallEnded();
                    break;
                case 'webrtc_offer':
                    handleOffer(data.offer, data.from);
                    break;
                case 'webrtc_answer':
                    handleAnswer(data.answer);
                    break;
                case 'webrtc_ice_candidate':
                    handleIceCandidate(data.candidate);
                    break;
                case 'call_timeout':
                    if (!currentCallUser) break;
                    addMessage('System',
                        translations[currentLanguage].callTimedOut,
                        'system'
                    );
                    cleanupCall();
                    break;
                case 'call_failed':
                    addMessage(
                        'System',
                        translations[currentLanguage].busy || 'User is busy',
                        'system'
                    );
                    cleanupCall();
                    break;
                case 'file_chunk_start':
                    receivingFile = true;
                    receivedChunks = [];
                    totalChunksExpected = data.totalChunks;
                    currentFileName = data.fileName;
                    currentFileSender = data.sender;
                    currentFileSize = data.fileSize;

                    showProgress(data.fileName, 'receive');

                    if (currentLanguage === 'ta') {
                        addMessage('System',
                            `${data.sender} அவர்களிடமிருந்து ${data.fileName} ${t.receiving} (${formatFileSize(data.fileSize)})...`,
                            'system'
                        );
                    } else {
                        addMessage('System',
                            `${t.receivingFileFrom} ${data.fileName} ${t.from} ${data.sender} (${formatFileSize(data.fileSize)})...`,
                            'system'
                        );
                    }
                    break;

                case 'file_chunk':
                    if (receivingFile) {
                        receivedChunks[data.chunkIndex] = data.chunkData;

                        const received = receivedChunks.filter(c => c).length;
                        updateProgress(received, totalChunksExpected, 'receive');
                    }
                    break;

                case 'file_chunk_end':
                    if (receivingFile) {
                        fileQueue.push({
                            sender: currentFileSender,
                            fileName: currentFileName,
                            chunks: receivedChunks,
                            size: currentFileSize,
                            totalChunks: totalChunksExpected
                        });

                        receivingFile = false;
                        receivedChunks = [];
                        totalChunksExpected = 0;
                        currentFileName = '';
                        currentFileSender = '';
                        currentFileSize = 0;

                        hideProgress();

                        setTimeout(() => {
                            processFileQueue();
                        }, 50);
                    }
                    break;

                case 'file_transfer_cancel':
                    receivingFile = false;
                    receivedChunks = [];
                    totalChunksExpected = 0;
                    currentFileName = '';
                    currentFileSender = '';
                    currentFileSize = 0;

                    hideProgress();
                    addMessage('System', translations[currentLanguage].fileTransferCancelledBySender, 'system');
                    break;


            }
        }

        function requestNotificationPermission() {
            if (!('Notification' in window)) return;

            if (Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }


        function showFileSaveDialog(sender, fileName, fileData, fileSize, isBlob = false) {
            const modal = document.getElementById('fileModal');
            const content = document.getElementById('fileDialogContent');
            const t = translations[currentLanguage];

            content.innerHTML = `
             <div class="file-dialog-info">
                <p><strong>${t.receivedFile}:</strong> ${fileName}</p>
                <p><strong>${t.fileSize}:</strong> ${formatFileSize(fileSize)}</p>
                <p><strong>${t.sender}:</strong> ${sender}</p>
            </div>

            <div class="file-dialog-buttons">
                <button class="btn-dialog secondary"
                    onclick="openPreviewModal('${fileData}', '${fileName}', ${isBlob})">
                    👁 ${translations[currentLanguage].preview}
                </button>

                <button class="btn-dialog secondary"
                    onclick="closeFileDialog(false,'${sender}','${fileName}')">
                     ${t.no}
                </button>

                <button class="btn-dialog primary"
                    onclick="saveFile('${fileName}','${fileData}','${sender}', ${isBlob})">
                    ${t.yes}
                </button>
            </div>
            `;

            modal.style.display = 'flex';
        }

        function saveFile(fileName, fileData, sender, isBlob = false) {

            const link = document.createElement('a');
            link.href = fileData;
            link.download = fileName;

            document.body.appendChild(link);
            link.click();

            document.body.removeChild(link);

            if (isBlob) {
                URL.revokeObjectURL(fileData);
            }

            addMessage(
                sender,
                `${translations[currentLanguage].file} : ${fileName} ${translations[currentLanguage].fileSaved}`,
                'received'
            );

            closeFileDialog(true, sender, fileName);
        }


        function closeFileDialog(saved, sender, fileName) {
            const modal = document.getElementById('fileModal');
            modal.style.display = 'none';

            if (!saved) {
                addMessage(sender, `${translations[currentLanguage].file} : ${fileName} ${translations[currentLanguage].fileNotSaved}`, 'received');
            }

            isShowingFileDialog = false;
            processFileQueue();
        }


        function addMessage(sender, content, type = 'received') {
            const container = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;

            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';

            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            if (type !== 'system' && type !== 'sent') {
                const senderDiv = document.createElement('div');
                senderDiv.className = 'message-sender';
                senderDiv.textContent = sender;
                bubble.appendChild(senderDiv);
            }

            const contentDiv = document.createElement('div');
            contentDiv.textContent = content;
            bubble.appendChild(contentDiv);

            const timeDiv = document.createElement('div');
            timeDiv.className = 'message-time';
            timeDiv.textContent = time;
            bubble.appendChild(timeDiv);

            messageDiv.appendChild(bubble);
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            if (!message || !ws) return;

            if (message.startsWith('/')) {
                handleCommand(message);
            } else {
                ws.send(JSON.stringify({
                    type: currentMode === 'private' ? 'private_message' : 'message',
                    content: message,
                    receiver: privateReceiver
                }));

                addMessage(translations[currentLanguage].you, message, 'sent');
            }

            input.value = '';
            input.style.height = 'auto';
            input.style.height = '44px';
            input.style.overflowY = 'hidden';
        }

        function handleCommand(command) {
            const parts = command.split(' ');

            switch (parts[0]) {
                case '/list':
                    ws.send(JSON.stringify({ type: 'list_users' }));
                    showUserList();
                    break;
                case '/chat':
                    if (parts[1]) {
                        ws.send(JSON.stringify({
                            type: 'enable_private',
                            receiver: parts[1]
                        }));
                    }
                    break;
                case '/group':
                    ws.send(JSON.stringify({ type: 'enable_group' }));
                    break;
                default:
                    addMessage('System', translations[currentLanguage].unknownCommand, 'system');
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function showUserList() {
            ws.send(JSON.stringify({ type: 'list_users' }));
            document.getElementById('userModal').style.display = 'flex';
        }

        function closeUserModal() {
            document.getElementById('userModal').style.display = 'none';
        }

        function displayUserList() {
            const userListDiv = document.getElementById('userList');
            userListDiv.innerHTML = '';

            const t = translations[currentLanguage];

            onlineUsers.forEach(user => {
                const userItem = document.createElement('div');
                userItem.className = 'user-item';

                const userInfo = document.createElement('div');
                userInfo.className = 'user-info';

                const avatar = document.createElement('div');
                avatar.className = 'user-avatar';
                avatar.textContent = user.name[0].toUpperCase();

                const userName = document.createElement('span');
                userName.textContent = user.name;

                userInfo.appendChild(avatar);
                userInfo.appendChild(userName);
                userItem.appendChild(userInfo);


                if (user.name !== username) {
                    const userActions = document.createElement('div');
                    userActions.className = 'user-actions';

                    const callBtn = document.createElement('button');
                    callBtn.className = 'btn-call';

                    if (user.callState !== 'idle') {
                        callBtn.textContent = t.inCall
                        callBtn.disabled = true;
                        callBtn.style.opacity = '0.6';
                        callBtn.style.cursor = 'not-allowed';
                    } else {
                        callBtn.innerHTML = '📞 ' + (t.callBtn || 'Call');
                        callBtn.onclick = () => {
                            initiateCall(user.name);
                            closeUserModal();
                        };
                    }


                    const videoCallBtn = document.createElement('button');
                    videoCallBtn.className = 'btn-call btn-video-call';

                    if (user.callState !== 'idle') {
                        videoCallBtn.textContent = '📹';
                        videoCallBtn.disabled = true;
                        videoCallBtn.style.opacity = '0.6';
                        videoCallBtn.style.cursor = 'not-allowed';
                    } else {
                        videoCallBtn.innerHTML = '📹';
                        videoCallBtn.onclick = () => {
                            initiateCall(user.name, true);
                            closeUserModal();
                        };
                    }

                    const chatBtn = document.createElement('button');
                    chatBtn.className = 'btn-chat';
                    chatBtn.textContent = t.chatBtn;
                    chatBtn.onclick = () => startPrivateChat(user.name);

                    userActions.appendChild(callBtn);
                    userActions.appendChild(videoCallBtn);
                    userActions.appendChild(chatBtn);
                    userItem.appendChild(userActions);
                }

                userListDiv.appendChild(userItem);
            });
        }

        function startPrivateChat(user) {
            ws.send(JSON.stringify({
                type: 'enable_private',
                receiver: user
            }));
            closeUserModal();
        }

        function enableGroupChat() {
            ws.send(JSON.stringify({ type: 'enable_group' }));
        }

        async function handleFileSelect(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert(translations[currentLanguage].notConnected);
                return;
            }

            const receiver = currentMode === 'private' ? privateReceiver : 'GROUP';
            const fileArray = Array.from(files);


            for (let i = 0; i < fileArray.length; i++) {
                const file = fileArray[i];

                addMessage(
                    'System',
                    `${translations[currentLanguage].sendingFile} ${file.name} (${formatFileSize(file.size)}) [${i + 1}/${fileArray.length}]`,
                    'system'
                );

                try {
                    await sendFileInChunks(file, receiver);

                    if (i < fileArray.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 300));
                    }
                } catch (error) {
                    console.error(`Failed to send ${file.name}:`, error);
                }
            }

            event.target.value = '';
        }

        async function sendFileInChunks(file, receiver) {
            const CHUNK_SIZE = 256 * 1024; // 256KB chunks
            const totalChunks = Math.ceil(file.size / CHUNK_SIZE);

            transferCancelled = false;
            showProgress(file.name, 'send');


            ws.send(JSON.stringify({
                type: 'file_chunk_start',
                receiver: receiver,
                fileName: file.name,
                fileSize: file.size,
                totalChunks: totalChunks
            }));

            const arrayBuffer = await file.arrayBuffer();
            const uint8Array = new Uint8Array(arrayBuffer);

            for (let i = 0; i < totalChunks; i++) {
                if (transferCancelled) {
                    ws.send(JSON.stringify({
                        type: 'file_transfer_cancel',
                        receiver: receiver
                    }));
                    hideProgress();
                    addMessage('System', translations[currentLanguage].fileTransferCancelled, 'system');
                    return;
                }

                const start = i * CHUNK_SIZE;
                const end = Math.min(start + CHUNK_SIZE, file.size);
                const chunk = uint8Array.slice(start, end);

                ws.send(JSON.stringify({
                    type: 'file_chunk',
                    receiver: receiver,
                    chunkIndex: i,
                    chunkData: Array.from(chunk)
                }));

                updateProgress(i + 1, totalChunks, 'send');


                if (i % 10 === 0) {
                    await new Promise(resolve => setTimeout(resolve, 0));
                }
            }

            ws.send(JSON.stringify({
                type: 'file_chunk_end',
                receiver: receiver,
                fileName: file.name
            }));

            addMessage(translations[currentLanguage].you,
                `${translations[currentLanguage].fileSent}: ${file.name} (${formatFileSize(file.size)})`,
                'sent'
            );
        }

        function getMimeType(dataUrl) {
            if (!dataUrl) return 'application/octet-stream';

            if (dataUrl.startsWith('blob:')) {
                return 'application/octet-stream';
            }

            const match = dataUrl.match(/^data:([^;]+);/);
            if (match && match[1]) {
                return match[1];
            }

            return 'application/octet-stream';
        }

        function formatFileSize(bytes) {
            if (!bytes) return '0 B';
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
            if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
            return (bytes / (1024 * 1024 * 1024)).toFixed(2) + ' GB';
        }

        function reconstructFile() {

            for (let i = 0; i < totalChunksExpected; i++) {
                if (!receivedChunks[i]) {
                    addMessage('System', translations[currentLanguage].fileTransferIncomplete, 'system');
                    hideProgress();
                    return;
                }
            }

            const buffers = receivedChunks.map(chunk => new Uint8Array(chunk));

            const blob = new Blob(buffers);


            const fileURL = URL.createObjectURL(blob);

            showFileSaveDialog(
                currentFileSender,
                currentFileName,
                fileURL,
                currentFileSize,
                true
            );

            hideProgress();

            receivingFile = false;
            receivedChunks = [];
            totalChunksExpected = 0;
            currentFileName = '';
            currentFileSender = '';
            currentFileSize = 0;
        }

        function processFileQueue() {

            if (fileQueue.length === 0) return;

            if (isShowingFileDialog) return;

            isShowingFileDialog = true;

            const fileInfo = fileQueue.shift();

            for (let i = 0; i < fileInfo.totalChunks; i++) {
                if (!fileInfo.chunks[i]) {
                    addMessage('System', `${translations[currentLanguage].fileTransferIncomplete}: ${fileInfo.fileName}`, 'system');
                    isShowingFileDialog = false;
                    processFileQueue();
                    return;
                }
            }

            const buffers = fileInfo.chunks.map(chunk => new Uint8Array(chunk));
            const mimeType = getMimeTypeFromFileName(fileInfo.fileName);
            const blob = new Blob(buffers, { type: mimeType });
            const fileURL = URL.createObjectURL(blob);

            showFileSaveDialog(
                fileInfo.sender,
                fileInfo.fileName,
                fileURL,
                fileInfo.size,
                true
            );
        }

        function showProgress(fileName, type = 'send') {
            const progressDiv = document.getElementById('fileProgress');
            const fileNameEl = document.getElementById('progressFileName');
            const t = translations[currentLanguage];

            fileNameEl.textContent = type === 'send'
                ? `${t.sending}: ${fileName}`
                : `${t.receiving}: ${fileName}`;

            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('progressPercent').textContent = '0%';
            document.getElementById('progressInfo').textContent = '0 / 0 chunks';

            progressDiv.style.display = 'block';
        }

        function updateProgress(current, total, type = 'send') {
            const t = translations[currentLanguage];
            const percent = Math.round((current / total) * 100);

            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressPercent').textContent = percent + '%';
            document.getElementById('progressInfo').textContent = `${current} / ${total} ${t.chunks}`;

            if (current >= total) {
                setTimeout(() => {
                    document.getElementById('fileProgress').style.display = 'none';
                }, 2000);
            }
        }

        function hideProgress() {
            document.getElementById('fileProgress').style.display = 'none';
        }

        function cancelFileTransfer() {
            transferCancelled = true;

            ws.send(JSON.stringify({
                type: 'file_transfer_cancel',
                receiver: currentMode === 'private' ? privateReceiver : 'GROUP'
            }));

            addMessage('System', translations[currentLanguage].fileTransferCancelled, 'system');
        }


        // WebRTC Functions
        async function initiateCall(targetUser, videoEnabled = false) {

            try {
                localStream = await navigator.mediaDevices.getUserMedia({
                    audio: true,
                    video: videoEnabled
                });

                isVideoCall = videoEnabled;

                currentCallUser = targetUser;
                isCallInitiator = true;

                ws.send(JSON.stringify({
                    type: 'call_request',
                    to: targetUser,
                    from: username,
                    callType: isVideoCall ? 'video' : 'audio'
                }));

                showCallModal(targetUser, 'outgoing');

            } catch (error) {
                alert(translations[currentLanguage].micPermissionDenied || 'Microphone permission denied');
            }
        }

        async function handleIncomingCall(caller, callType) {
            isVideoCall = (callType === 'video');

            if (currentCallUser) {
                ws.send(JSON.stringify({
                    type: 'call_rejected',
                    to: caller,
                    from: username
                }));
                return;
            }

            const t = translations[currentLanguage];

            currentCallUser = caller;
            isCallInitiator = false;
            showCallModal(caller, 'incoming');
            if (Notification.permission === 'granted') {
                new Notification(`${t.incomingCall} 📞`, {
                    body: `${caller}${t.isCalligYou}`,
                    icon: '📞',
                    requireInteraction: true
                });
            }
        }

        async function acceptCall() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({
                    audio: true,
                    video: isVideoCall
                });

                ws.send(JSON.stringify({
                    type: 'call_accepted',
                    to: currentCallUser,
                    from: username
                }));

                await createPeerConnection();
                showCallModal(currentCallUser, 'active');

            } catch (error) {
                alert(translations[currentLanguage].micPermissionDenied || 'Microphone permission denied');
                rejectCall();
            }
        }

        function rejectCall() {
            ws.send(JSON.stringify({
                type: 'call_rejected',
                to: currentCallUser,
                from: username
            }));

            closeCallModal();
            currentCallUser = '';
        }

        async function handleCallAccepted() {
            await createPeerConnection();

            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);

            ws.send(JSON.stringify({
                type: 'webrtc_offer',
                offer: offer,
                to: currentCallUser,
                from: username
            }));

            showCallModal(currentCallUser, 'active');
        }

        function handleCallRejected(reason) {
            const t = translations[currentLanguage];
            let message = `${currentCallUser} ${t.callRejected || 'rejected the call'}`;

            if (reason === 'DIFFERENT_COUNTRY') {
                message = translations[currentLanguage].countryBlocked;
            }

            addMessage('System', message, 'system');
            closeCallModal();
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            currentCallUser = '';
        }

        async function createPeerConnection() {
            peerConnection = new RTCPeerConnection(configuration);

            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });

            peerConnection.ontrack = (event) => {

                event.streams.forEach(stream => {

                    if (event.track.kind === 'video') {
                        if (remoteVideo) {
                            remoteVideo.srcObject = stream;
                        }
                    }

                    if (event.track.kind === 'audio') {
                        if (remoteAudio) {
                            remoteAudio.srcObject = stream;
                        }
                    }
                });
            };

            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    ws.send(JSON.stringify({
                        type: 'webrtc_ice_candidate',
                        candidate: event.candidate,
                        to: currentCallUser,
                        from: username
                    }));
                }
            };

            peerConnection.onconnectionstatechange = () => {
                if (peerConnection.connectionState === 'connected') {
                    startCallTimer();
                }
                if (peerConnection.connectionState === 'disconnected' ||
                    peerConnection.connectionState === 'failed') {
                    endCall();
                }
            };
        }

        function initiateVideoCall(targetUser) {
            initiateCall(targetUser, true);
        }

        function toggleCamera() {
            if (localStream && isVideoCall) {
                const videoTrack = localStream.getVideoTracks()[0];
                if (videoTrack) {
                    videoTrack.enabled = !videoTrack.enabled;
                    cameraEnabled = videoTrack.enabled;

                    const cameraBtn = document.getElementById('cameraBtn');
                    if (cameraBtn) {
                        if (cameraEnabled) {
                            cameraBtn.classList.remove('active');
                            cameraBtn.textContent = '📹';
                        } else {
                            cameraBtn.classList.add('active');
                            cameraBtn.textContent = '📵';
                        }
                    }
                }
            }
        }

        async function handleOffer(offer, from) {

            if (!localStream) {
                localStream = await navigator.mediaDevices.getUserMedia({
                    audio: true,
                    video: isVideoCall
                });
            }

            if (!peerConnection) {
                await createPeerConnection();
            }

            await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));

            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);

            ws.send(JSON.stringify({
                type: 'webrtc_answer',
                answer,
                to: from,
                from: username
            }));
        }

        async function handleAnswer(answer) {
            await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
        }

        async function handleIceCandidate(candidate) {
            if (peerConnection) {
                await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
            }
        }

        function toggleMute() {
            if (localStream) {
                const audioTrack = localStream.getAudioTracks()[0];
                if (audioTrack) {
                    audioTrack.enabled = !audioTrack.enabled;
                    isMuted = !audioTrack.enabled;

                    const muteBtn = document.getElementById('muteBtn');
                    if (isMuted) {
                        muteBtn.classList.add('active');
                        muteBtn.textContent = '🔇';
                    } else {
                        muteBtn.classList.remove('active');
                        muteBtn.textContent = '🎤';
                    }
                }
            }
        }

        function endCall() {
            ws.send(JSON.stringify({
                type: 'call_ended',
                to: currentCallUser,
                from: username
            }));

            cleanupCall();
        }

        function handleCallEnded() {
            if (!currentCallUser) return;
            const t = translations[currentLanguage];
            addMessage('System', `${t.callEnded || 'Call ended'}`, 'system');
            cleanupCall();
        }

        function cleanupCall() {
            if (callTimer) {
                clearInterval(callTimer);
                callTimer = null;
            }

            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }

            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }

            isVideoCall = false;
            cameraEnabled = true;

            const videoContainer = document.getElementById('videoContainer');
            const callContainer = document.querySelector('.call-container');
            const activeControls = document.getElementById('activeCallControls');
            const timer = document.getElementById('callTimer');

            if (videoContainer) videoContainer.style.display = 'none';
            if (localVideo) localVideo.srcObject = null;
            if (remoteVideo) remoteVideo.srcObject = null;

            if (callContainer) {
                callContainer.style.padding = '';
                callContainer.style.maxWidth = '';
                callContainer.style.width = '';
                callContainer.style.height = '';
                callContainer.style.borderRadius = '';
            }

            if (activeControls) {
                activeControls.style.position = '';
                activeControls.style.bottom = '';
                activeControls.style.left = '';
                activeControls.style.transform = '';
            }

            if (timer) {
                timer.style.position = '';
                timer.style.top = '';
                timer.style.left = '';
                timer.style.transform = '';
            }

            closeCallModal();
            currentCallUser = '';
            isMuted = false;
            callStartTime = null;
        }

        function showCallModal(targetUser, state) {
            const modal = document.getElementById('callModal');
            const avatar = document.getElementById('callAvatar');
            const name = document.getElementById('callName');
            const status = document.getElementById('callStatus');
            const timer = document.getElementById('callTimer');
            const activeControls = document.getElementById('activeCallControls');
            const incomingControls = document.getElementById('incomingCallControls');
            const videoContainer = document.getElementById('videoContainer');
            const cameraBtn = document.getElementById('cameraBtn');
            const callContainer = document.querySelector('.call-container');
            const t = translations[currentLanguage];

            avatar.textContent = targetUser[0].toUpperCase();
            name.textContent = targetUser;

            activeControls.style.display = 'none';
            incomingControls.style.display = 'none';
            timer.style.display = 'none';
            videoContainer.style.display = 'none';
            avatar.style.display = 'flex';
            if (cameraBtn) cameraBtn.style.display = 'none';

            if (state === 'incoming') {
                status.textContent = t.incomingCall || 'Incoming call...';
                incomingControls.style.display = 'flex';
            } else if (state === 'outgoing') {
                status.textContent = t.calling || 'Calling...';
                activeControls.style.display = 'flex';
                if (isVideoCall && cameraBtn) cameraBtn.style.display = 'flex';
            } else if (state === 'active') {
                status.textContent = t.connected || 'Connected';
                activeControls.style.display = 'flex';
                timer.style.display = 'block';

                if (isVideoCall) {

                    videoContainer.style.display = 'block';

                    if (remoteVideo) {
                        remoteVideo.setAttribute('playsinline', true);
                        remoteVideo.muted = false;
                    }

                    callContainer.style.padding = '0';
                    callContainer.style.maxWidth = '100vw';
                    callContainer.style.width = '100%';
                    callContainer.style.height = '100vh';
                    callContainer.style.borderRadius = '0';

                    videoContainer.style.display = 'block';
                    videoContainer.style.position = 'relative';
                    videoContainer.style.width = '100%';
                    videoContainer.style.height = '100%';

                    avatar.style.display = 'none';
                    name.style.display = 'none';
                    status.style.display = 'none';

                    activeControls.style.position = 'absolute';
                    activeControls.style.bottom = '20px';
                    activeControls.style.left = '50%';
                    activeControls.style.transform = 'translateX(-50%)';
                    activeControls.style.zIndex = '20';

                    timer.style.position = 'absolute';
                    timer.style.top = '30px';
                    timer.style.left = '50%';
                    timer.style.transform = 'translateX(-50%)';
                    timer.style.zIndex = '20';
                    timer.style.fontSize = '18px';
                    timer.style.color = '#22c55e';
                    timer.style.fontWeight = '600';
                    timer.style.textShadow = '0 2px 4px rgba(0,0,0,0.5)';

                    if (cameraBtn) cameraBtn.style.display = 'flex';



                    if (localStream && localVideo) {
                        localVideo.srcObject = localStream;
                    }
                }
            }

            modal.style.display = 'flex';
        }

        function closeCallModal() {
            document.getElementById('callModal').style.display = 'none';
        }

        function startCallTimer() {
            callStartTime = Date.now();
            callTimer = setInterval(() => {
                const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                document.getElementById('callTimer').textContent =
                    `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }, 1000);
        }

        function updateUILanguage() {
            const t = translations[currentLanguage];

            document.documentElement.lang = currentLanguage;

            document.getElementById('appTitle').textContent = t.appTitle;
            document.getElementById('appSubtitle').textContent = t.appSubtitle;
            document.getElementById('usernameLabel').textContent = t.usernameLabel;
            document.getElementById('usernameInput').placeholder = t.usernamePlaceholder;
            document.getElementById('infoText').textContent = t.infoText;
            document.getElementById('langToggleText').textContent = t.langToggle;
            document.getElementById('connectBtn').textContent = t.connectBtn;
            document.getElementById('statusText').textContent = t.connecting;

            document.getElementById('chatTitle').textContent = t.chatTitle;
            document.getElementById('usersBtnText').textContent = t.usersBtn;
            document.getElementById('groupBtnText').textContent = t.groupBtn;
            document.getElementById('themeBtnText').textContent = t.themeBtn;
            document.getElementById('langToggleChatText').textContent = t.langToggle;
            document.getElementById('modalTitle').textContent = t.modalTitle;
            document.getElementById('messageInput').placeholder = t.typeMessage;
            document.getElementById('fileModalTitle').textContent = t.incomingFileTitle;
            document.querySelector('#previewModal h3').textContent = t.filePreviewTitle;

            const infoModalTitle = document.getElementById('infoModalTitle');
            if (infoModalTitle) {
                infoModalTitle.textContent = t.infoModalTitle;
            }

            const infoModalBtn = document.getElementById('infoModalBtn');
            if (infoModalBtn) {
                infoModalBtn.textContent = t.gotIt;
            }

            if (username && currentMode === 'group') {
                document.getElementById('statusText').textContent = username + ' • ' + t.groupChat;
            } else if (username && currentMode === 'private') {
                if (currentLanguage === 'ta') {
                    document.getElementById('statusText').textContent = username + ' • ' + privateReceiver + ' ' + t.privateChat;
                } else {
                    document.getElementById('statusText').textContent = username + ' • ' + t.privateChat + ' ' + privateReceiver;
                }
            }
        }


        function toggleLanguage() {
            currentLanguage = currentLanguage === 'en' ? 'ta' : 'en';
            updateUILanguage();

            if (currentLanguage === 'ta') {
                document.body.classList.add('tamil');
            } else {
                document.body.classList.remove('tamil');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.body.classList.add('tamil');
            updateUILanguage();
            document.getElementById('usernameInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') connect();
            });
        });

        let viewportHeight = window.visualViewport ? window.visualViewport.height : window.innerHeight;

        if (window.visualViewport) {
            window.visualViewport.addEventListener('resize', () => {
                const currentHeight = window.visualViewport.height;
                const heightDiff = viewportHeight - currentHeight;

                if (heightDiff > 100) {
                    document.body.classList.add('keyboard-open');
                } else {
                    document.body.classList.remove('keyboard-open');
                    viewportHeight = currentHeight;
                }
            });
        }

        document.getElementById('messageInput').addEventListener('focus', function () {
            setTimeout(() => {
                const container = document.getElementById('messagesContainer');
                container.scrollTop = container.scrollHeight;
            }, 300);
        });

        document.getElementById('messageInput').addEventListener('touchmove', function (e) {
            e.stopPropagation();
        }, { passive: true });



        function isArchiveFile(mime, fileName) {
            return (
                mime === 'application/zip' ||
                mime === 'application/x-zip-compressed' ||
                mime === 'application/x-rar-compressed' ||
                mime === 'application/x-7z-compressed' ||
                fileName.endsWith('.zip') ||
                fileName.endsWith('.rar') ||
                fileName.endsWith('.7z')
            );
        }

        function getMimeTypeFromFileName(fileName) {
            const ext = fileName.split('.').pop().toLowerCase();

            const map = {
                png: 'image/png',
                jpg: 'image/jpeg',
                jpeg: 'image/jpeg',
                gif: 'image/gif',
                webp: 'image/webp',
                mp4: 'video/mp4',
                webm: 'video/webm',
                mp3: 'audio/mpeg',
                wav: 'audio/wav',
                pdf: 'application/pdf'
            };

            return map[ext] || 'application/octet-stream';
        }



        function isCodeFile(fileName) {
            const codeExtensions = [
                'js', 'ts', 'jsx', 'tsx',
                'html', 'css',
                'java', 'py', 'php', 'rb', 'go',
                'c', 'cpp', 'h', 'cs',
                'json', 'xml', 'yml', 'yaml',
                'sql', 'md', 'env', 'ini', 'properties',
                'sh', 'bat', 'ps1', 'txt'
            ];

            const ext = fileName.split('.').pop().toLowerCase();
            return codeExtensions.includes(ext);
        }



        async function openPreviewModal(fileData, fileName, isBlob = false) {
            const modal = document.getElementById('previewModal');
            const content = document.getElementById('previewModalContent');

            if (!modal || !content) return;

            const mime = isBlob ? getMimeTypeFromFileName(fileName) : getMimeType(fileData);

            let inner = '';

            if (mime.startsWith('image/')) {
                inner = `<img src="${fileData}" alt="${fileName}" style="max-width:100%; height:auto;">`;
            }
            else if (mime.startsWith('video/')) {
                inner = `<video controls playsinline style="max-width:100%;"><source src="${fileData}" type="${mime}"></video>`;
            }
            else if (mime.startsWith('audio/')) {
                inner = `<audio controls style="width:100%;"><source src="${fileData}" type="${mime}"></audio>`;
            }
            else if (mime === 'application/pdf') {
                inner = `
                    <iframe 
                        src="${fileData}" 
                        width="100%" 
                        height="75vh" 
                        style="border:none;">
                    </iframe>
                    <div style="padding:10px;text-align:center;">
                        <a href="${fileData}" download="${fileName}" 
                        style="color:#22c55e;text-decoration:none;font-weight:500;">
                        ⬇️ ${translations[currentLanguage].downloadPdf}
                        </a>
                    </div>
    `;
            }
            else if (isCodeFile(fileName)) {
                try {
                    const response = await fetch(fileData);
                    const text = await response.text();
                    inner = `<pre style="white-space:pre;overflow-x:auto;font-family:monospace;font-size:13px;line-height:1.6;padding:12px;background:rgba(0,0,0,0.35);border-radius:10px;">${escapeHtml(text)}</pre>`;
                } catch (e) {
                    inner = `<div style="padding:20px;text-align:center;">${translations[currentLanguage].previewError}</div>`;
                }
            }
            else {
                inner = `<div style="padding:20px;text-align:center;">📄 ${translations[currentLanguage].previewNotAvailable}<br><span style="font-size:12px;opacity:0.8;">${translations[currentLanguage].downloadToView}</span></div>`;
            }

            content.innerHTML = `<div class="preview-wrapper"><div class="preview-content">${inner}</div></div>`;
            modal.style.display = 'flex';
        }

        function closePreviewModal() {
            document.getElementById('previewModal').style.display = 'none';
            document.getElementById('previewModalContent').innerHTML = '';
            document.body.classList.remove('preview-open');
        }

        function escapeHtml(text) {
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;");
        }

        async function toggleSpeaker() {
            const audio = document.getElementById('remoteAudio');
            const btn = document.getElementById('speakerBtn');


            if (!audio || typeof audio.setSinkId !== 'function') {
                alert(`${translations[currentLanguage].speakerNotSupported}`);
                return;
            }

            const devices = await navigator.mediaDevices.enumerateDevices();
            const outputs = devices.filter(d => d.kind === 'audiooutput');

            if (!outputs.length) {
                alert(`${translations[currentLanguage].noAudioOutput}`);
                return;
            }

            const speaker = outputs.find(d =>
                d.label.toLowerCase().includes('speaker')
            );

            const defaultDevice = outputs.find(d => d.deviceId === 'default') || outputs[0];

            isSpeakerOn = !isSpeakerOn;

            await audio.setSinkId(
                isSpeakerOn
                    ? (speaker?.deviceId || defaultDevice.deviceId)
                    : defaultDevice.deviceId
            );

            btn.textContent = isSpeakerOn ? '🔊' : '📞';
        }


        function showInfoModal() {
            const t = translations[currentLanguage];

            const content = currentLanguage === 'ta'
                ? `
                    👋 <b>அரட்டையை தொடங்குவதற்கு முன் ஒரு சிறிய தகவல்…</b><br><br>
                    • இது ஒரு <b>தனிப்பட்ட உரையாடல்</b>. பக்கத்தை புதுப்பித்தால் <b>புதிய உரையாடல்</b> தொடங்கும்.<br>
                    • <b>செய்திகள் அல்லது கோப்புகள் எங்கும் சேமிக்கப்படவில்லை</b>.<br>
                    • அனைத்து பயனர்களும் ஆரம்பத்தில் <b>குழு அரட்டையில்</b> இணைக்கப்படுவார்கள்.<br>
                    • <b>தனிப்பட்ட செய்திகள் மஞ்சள் நிற பெட்டியில்</b> காண்பிக்கப்படும்.<br>
                    • <b>தனிப்பட்ட செய்தி அனுப்ப</b>, <b>உறுப்பினர்கள் → Chat</b> பொத்தானை அழுத்தவும்.<br>
                    • <b>ஒருவருக்கு ஒருவர் அழைப்பு</b> வசதி உள்ளது (ஒரே பிணையத்திற்குள் மட்டும்). 🌍<br><br>
                    😊 மகிழ்ச்சியாக பேசுங்கள்!
                `
                : `
                    👋 <b>Welcome! Before you start chatting…</b><br><br>
                    • This is a <b>private chat</b>. Refreshing the page starts a <b>new conversation</b>.<br>
                    • <b>Messages and files are not stored anywhere</b>.<br>
                    • All users are <b>initially connected to Group chat</b>.<br>
                    • <b>Private messages appear in a yellow bubble</b>.<br>
                    • To send a <b>private message</b>, click <b>Users → Chat</b>.<br>
                    • <b>One-to-one calls are available</b> (within the same network only). 🌍<br><br>
                    😊 Enjoy chatting!
                `;

            document.getElementById('infoModalContent').innerHTML = content;
            document.getElementById('infoModal').style.display = 'flex';
            document.getElementById('infoModalTitle').textContent = t.infoModalTitle;
            document.getElementById('infoModalBtn').textContent = t.gotIt;
        }

        function closeInfoModal() {
            document.getElementById('infoModal').style.display = 'none';
        }
    </script>

</body>

</html>
